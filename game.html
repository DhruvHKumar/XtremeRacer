<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xtreme Racer</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Exo+2:wght@400;700&display=swap">
    <style>
        :root {
            --primary: #ff3e00;
            --secondary: #2c3e50;
            --accent: #00c6ff;
            --dark: #121212;
            --light: #f5f5f5;
            --success: #00e676;
            --warning: #ffab00;
            --danger: #ff1744;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: var(--light);
            font-family: 'Exo 2', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .game-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 10px;
        }
        
        .game-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            text-shadow: 0 0 10px rgba(255, 62, 0, 0.5);
            margin: 0;
        }
        
        #score {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            font-weight: 700;
            color: var(--light);
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }
        
        .stats-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            backdrop-filter: blur(5px);
        }
        
        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            font-weight: 700;
        }
        
        #boostBarContainer {
            width: 100%;
            height: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5) inset;
        }
        
        #boostBar {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #ff9500, #ff3e00);
            border-radius: 10px;
            transition: width 0.1s linear;
            box-shadow: 0 0 5px rgba(255, 62, 0, 0.7);
        }
        
        #gameArea {
            width: 100%;
            height: 600px;
            position: relative;
            overflow: hidden;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            background-color: #1e1e1e;
        }
        
        .road {
            position: absolute;
            width: 100%;
            height: 200%;
            top: -50%;
            background-color: #1e1e1e;
            z-index: 1;
        }
        
        .lane-marker {
            position: absolute;
            width: 10px;
            height: 60px;
            background-color: rgba(255, 255, 255, 0.7);
            z-index: 2;
        }
        
        .road-edge {
            position: absolute;
            width: 20px;
            height: 100%;
            z-index: 2;
        }
        
        .road-edge-marker {
            position: absolute;
            width: 20px;
            height: 100px;
            background-color: var(--primary);
            z-index: 2;
        }
        
        .left-edge {
            left: 0;
        }
        
        .right-edge {
            right: 0;
        }
        
        #playerCar {
            width: 50px;
            height: 80px;
            position: absolute;
            bottom: 20px;
            z-index: 10;
            transition: left 0.1s ease-out;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 50 80'%3E%3Cpath d='M10,75 L10,65 C10,55 10,45 10,35 L15,15 C15,10 35,10 35,15 L40,35 C40,45 40,55 40,65 L40,75 Z' fill='%23ff3e00'/%3E%3Cpath d='M15,15 L35,15 L35,35 L15,35 Z' fill='%23333'/%3E%3Ccircle cx='15' cy='65' r='5' fill='%23333'/%3E%3Ccircle cx='35' cy='65' r='5' fill='%23333'/%3E%3C/svg%3E");
            filter: drop-shadow(0 0 5px rgba(255, 62, 0, 0.7));
        }
        
        .traffic {
            width: 50px;
            height: 80px;
            position: absolute;
            z-index: 5;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 50 80'%3E%3Cpath d='M10,75 L10,65 C10,55 10,45 10,35 L15,15 C15,10 35,10 35,15 L40,35 C40,45 40,55 40,65 L40,75 Z' fill='%23ffab00'/%3E%3Cpath d='M15,15 L35,15 L35,35 L15,35 Z' fill='%23333'/%3E%3Ccircle cx='15' cy='65' r='5' fill='%23333'/%3E%3Ccircle cx='35' cy='65' r='5' fill='%23333'/%3E%3C/svg%3E");
            filter: drop-shadow(0 0 5px rgba(255, 171, 0, 0.7));
        }
        
        .powerup {
            width: 30px;
            height: 30px;
            position: absolute;
            border-radius: 50%;
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 10px currentColor;
            animation: pulse 1s infinite alternate;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }
        
        .speed-boost { 
            background: radial-gradient(circle, #ff9500, #ff3e00);
            color: #ff3e00;
        }
        
        .invincibility { 
            background: radial-gradient(circle, #00c6ff, #0072ff);
            color: #0072ff;
        }
        
        .score-multiplier { 
            background: radial-gradient(circle, #00e676, #00c853);
            color: #00c853;
        }
        
        .powerup::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: inherit;
            filter: blur(5px);
            opacity: 0.7;
            z-index: -1;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            width: 100%;
        }
        
        .game-buttons {
            display: flex;
            gap: 10px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-family: 'Exo 2', sans-serif;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            backdrop-filter: blur(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.3);
        }
        
        button:active {
            transform: translateY(1px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        #startBtn {
            background: linear-gradient(135deg, #00c853, #009624);
            color: white;
        }
        
        #endBtn {
            background: linear-gradient(135deg, #ff1744, #d50000);
            color: white;
        }
        
        #dpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 5px;
            width: 120px;
            height: 120px;
        }
        
        .dpad-btn {
            width: 100%;
            height: 100%;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            transition: all 0.1s;
        }
        
        .dpad-btn:active {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(0.95);
        }
        
        #dpad-up { grid-column: 2; grid-row: 1; }
        #dpad-left { grid-column: 1; grid-row: 2; }
        #dpad-center { grid-column: 2; grid-row: 2; background: transparent; cursor: default; }
        #dpad-right { grid-column: 3; grid-row: 2; }
        #dpad-boost { 
            grid-column: 2; 
            grid-row: 3; 
            background: linear-gradient(135deg, #ff9500, #ff3e00);
            color: white;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: var(--light);
            padding: 30px;
            width: 90%;
            max-width: 600px;
            margin: 50px auto;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            color: var(--primary);
            margin: 0;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-body h3 {
            color: var(--accent);
            margin: 15px 0 10px;
            font-family: 'Orbitron', sans-serif;
        }
        
        .modal-body ul {
            padding-left: 20px;
            margin-bottom: 15px;
        }
        
        .modal-body li {
            margin-bottom: 5px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .powerup-display {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 100;
        }
        
        .active-powerup {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            display: flex;
            align-items: center;
            gap: 5px;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .multiplier { background-color: var(--success); }
        .invincible { background-color: var(--accent); }
        
        .timer {
            margin-left: auto;
        }
        
        .particles {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 3;
        }
        
        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: white;
            border-radius: 50%;
            opacity: 0.7;
        }
        
        .debug-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
            z-index: 100;
            display: none;
        }
        
        @media (max-width: 600px) {
            .game-title {
                font-size: 24px;
            }
            
            #score {
                font-size: 20px;
            }
            
            .controls {
                flex-direction: column;
                gap: 20px;
            }
            
            #dpad {
                width: 150px;
                height: 150px;
            }
            
            .modal-content {
                width: 95%;
                margin: 20px auto;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h1 class="game-title">XTREME RACER</h1>
            <div id="score">Score: 0</div>
        </div>
        
        <div class="stats-container">
            <div class="stat">
                <div class="stat-label">SPEED</div>
                <div class="stat-value" id="speedValue">1x</div>
            </div>
            <div class="stat">
                <div class="stat-label">BOOST</div>
                <div id="boostBarContainer">
                    <div id="boostBar"></div>
                </div>
            </div>
            <div class="stat">
                <div class="stat-label">LEVEL</div>
                <div class="stat-value" id="levelValue">1</div>
            </div>
        </div>
        
        <div id="gameArea">
            <div class="road" id="road"></div>
            <div id="laneMarkers"></div>
            <div id="roadEdges"></div>
            <div id="playerCar"></div>
            <div class="powerup-display" id="powerupDisplay"></div>
            <div class="particles" id="particles"></div>
            <div class="debug-info" id="debugInfo"></div>
        </div>
        
        <div class="controls">
            <div class="game-buttons">
                <button id="startBtn">START GAME</button>
                <button id="endBtn" disabled>END GAME</button>
            </div>
            
            <div id="dpad">
                <div class="dpad-btn" id="dpad-up">‚Üë</div>
                <div class="dpad-btn" id="dpad-left">‚Üê</div>
                <div class="dpad-btn" id="dpad-center"></div>
                <div class="dpad-btn" id="dpad-right">‚Üí</div>
                <div class="dpad-btn" id="dpad-boost">BOOST</div>
            </div>
        </div>
    </div>
    
    <div id="instructionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">XTREME RACER - HOW TO PLAY</h2>
            </div>
            <div class="modal-body">
                <p>Welcome to XTREME RACER! Control your car to avoid traffic and collect power-ups on a five-lane highway.</p>
                
                <h3>CONTROLS</h3>
                <ul>
                    <li><b>Left/Right Arrow Keys</b> or <b>D-Pad (‚Üê/‚Üí)</b>: Move between lanes.</li>
                    <li><b>Right Shift Key</b> or <b>BOOST Button</b>: Activate a speed boost (5-second cooldown).</li>
                </ul>
                
                <h3>GAME MECHANICS</h3>
                <ul>
                    <li><b>Objective</b>: Dodge yellow traffic cars to score points. Score increases per car that passes.</li>
                    <li><b>Speed</b>: Game speed increases gradually with your score and level.</li>
                    <li><b>Collisions</b>: Hitting traffic ends the game unless you're invincible.</li>
                </ul>
                
                <h3>POWER-UPS</h3>
                <ul>
                    <li><b>Speed Boost (Orange)</b>: Triggers a 1-second speed boost.</li>
                    <li><b>Invincibility (Blue)</b>: Prevents collisions for 5 seconds.</li>
                    <li><b>Score Multiplier (Green)</b>: Doubles points per traffic car for 10 seconds.</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button id="closeInstructions">START RACING!</button>
            </div>
        </div>
    </div>
    
    <div id="gameOverModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="gameOverTitle">GAME OVER!</h2>
            </div>
            <div class="modal-body">
                <p>Your final score: <span id="finalScore" class="stat-value">0</span></p>
                <p>Level reached: <span id="finalLevel" class="stat-value">1</span></p>
            </div>
            <div class="modal-footer">
                <button id="restartBtn">RACE AGAIN</button>
                <button id="homeBtn">MAIN MENU</button>
            </div>
        </div>
    </div>
    
    <script>
        // DOM Elements
        const gameArea = document.getElementById('gameArea');
        const road = document.getElementById('road');
        const laneMarkers = document.getElementById('laneMarkers');
        const roadEdges = document.getElementById('roadEdges');
        const playerCar = document.getElementById('playerCar');
        const scoreDisplay = document.getElementById('score');
        const speedValue = document.getElementById('speedValue');
        const levelValue = document.getElementById('levelValue');
        const startBtn = document.getElementById('startBtn');
        const endBtn = document.getElementById('endBtn');
        const dpadLeft = document.getElementById('dpad-left');
        const dpadRight = document.getElementById('dpad-right');
        const dpadBoost = document.getElementById('dpad-boost');
        const instructionsModal = document.getElementById('instructionsModal');
        const closeInstructions = document.getElementById('closeInstructions');
        const boostBar = document.getElementById('boostBar');
        const gameOverModal = document.getElementById('gameOverModal');
        const gameOverTitle = document.getElementById('gameOverTitle');
        const finalScoreDisplay = document.getElementById('finalScore');
        const finalLevelDisplay = document.getElementById('finalLevel');
        const restartBtn = document.getElementById('restartBtn');
        const homeBtn = document.getElementById('homeBtn');
        const powerupDisplay = document.getElementById('powerupDisplay');
        const particles = document.getElementById('particles');
        const debugInfo = document.getElementById('debugInfo');
        
        // Game variables
        let playerLane = 2;
        const laneCount = 5;
        const gameWidth = gameArea.offsetWidth;
        const laneWidth = gameWidth / laneCount;
        const lanes = Array.from({length: laneCount}, (_, i) => (i * laneWidth) + (laneWidth - 50) / 2);
        let score = 0;
        let level = 1;
        let baseSpeed = 2;
        let gameSpeed = baseSpeed;
        let trafficCars = [];
        let powerups = [];
        let gameOver = false;
        let gameRunning = false;
        let animationFrame;
        let boostActive = false;
        let lastBoostTime = 0;
        const boostCooldown = 5000;
        let isInvincible = false;
        let invincibilityEndTime = 0;
        let scoreMultiplier = 1;
        let scoreMultiplierEndTime = 0;
        let activeParticles = [];
        let lastFrameTime = 0;
        let fps = 0;
        let laneMarkerPositions = [];
        let roadEdgeMarkerPositions = [];
        let safeZones = []; // Track occupied zones to prevent overlaps
        
        // Debug mode
        const DEBUG_MODE = false;
        
        // Create lane markers
        function createLaneMarkers() {
            laneMarkers.innerHTML = '';
            
            // Create lane markers
            for (let lane = 1; lane < laneCount; lane++) {
                const laneX = lane * laneWidth - 5; // Center the 10px wide marker
                
                // Create multiple markers for each lane with different positions
                for (let i = 0; i < 12; i++) {
                    const marker = document.createElement('div');
                    marker.className = 'lane-marker';
                    marker.style.left = laneX + 'px';
                    marker.style.top = (i * 100 - 100) + 'px'; // Start above the visible area
                    laneMarkers.appendChild(marker);
                    
                    laneMarkerPositions.push({
                        element: marker,
                        x: laneX,
                        y: i * 100 - 100,
                        lane: lane
                    });
                }
            }
            
            // Create road edge markers
            roadEdges.innerHTML = '';
            
            // Left edge
            for (let i = 0; i < 8; i++) {
                const marker = document.createElement('div');
                marker.className = 'road-edge-marker left-edge';
                marker.style.left = '0px';
                marker.style.top = (i * 150 - 100) + 'px';
                roadEdges.appendChild(marker);
                
                roadEdgeMarkerPositions.push({
                    element: marker,
                    x: 0,
                    y: i * 150 - 100,
                    side: 'left'
                });
            }
            
            // Right edge
            for (let i = 0; i < 8; i++) {
                const marker = document.createElement('div');
                marker.className = 'road-edge-marker right-edge';
                marker.style.right = '0px';
                marker.style.top = (i * 150 - 100) + 'px';
                roadEdges.appendChild(marker);
                
                roadEdgeMarkerPositions.push({
                    element: marker,
                    x: gameWidth - 20,
                    y: i * 150 - 100,
                    side: 'right'
                });
            }
        }
        
        // Update lane markers
        function updateLaneMarkers() {
            // Update lane markers
            for (let marker of laneMarkerPositions) {
                marker.y += gameSpeed;
                
                if (marker.y > 600) {
                    marker.y = -60;
                }
                
                marker.element.style.top = marker.y + 'px';
            }
            
            // Update road edge markers
            for (let marker of roadEdgeMarkerPositions) {
                marker.y += gameSpeed;
                
                if (marker.y > 600) {
                    marker.y = -100;
                }
                
                if (marker.side === 'left') {
                    marker.element.style.top = marker.y + 'px';
                } else {
                    marker.element.style.top = marker.y + 'px';
                }
            }
        }
        
        // Show instructions initially
        instructionsModal.style.display = 'block';
        
        closeInstructions.addEventListener('click', () => {
            instructionsModal.style.display = 'none';
            createLaneMarkers();
        });
        
        // Restart game
        restartBtn.addEventListener('click', () => {
            gameOverModal.style.display = 'none';
            startGame();
        });
        
        // Back to home
        homeBtn.addEventListener('click', () => {
            gameOverModal.style.display = 'none';
            resetGame();
            instructionsModal.style.display = 'block';
        });
        
        // Update player position
        function updatePlayerPosition() {
            playerCar.style.left = lanes[playerLane] + 'px';
        }
        
        // Move player
        function movePlayer(direction) {
            if (!gameRunning || gameOver) return;
            if (direction === 'left' && playerLane > 0) playerLane--;
            if (direction === 'right' && playerLane < laneCount - 1) playerLane++;
            updatePlayerPosition();
        }
        
        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') movePlayer('left');
            if (e.key === 'ArrowRight') movePlayer('right');
            if (e.key === 'Shift' && e.location === KeyboardEvent.DOM_KEY_LOCATION_RIGHT) {
                activateBoost();
            }
            
            // Debug mode toggle
            if (e.key === 'd' && e.ctrlKey && e.altKey) {
                debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
            }
        });
        
        // D-Pad controls
        dpadLeft.addEventListener('click', () => movePlayer('left'));
        dpadRight.addEventListener('click', () => movePlayer('right'));
        dpadBoost.addEventListener('click', () => activateBoost());
        
        // Create particle effect
        function createParticles(x, y, count, color) {
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                particle.style.backgroundColor = color;
                
                const size = Math.random() * 3 + 2;
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 3 + 1;
                const vx = Math.cos(angle) * speed;
                const vy = Math.sin(angle) * speed;
                
                const lifespan = Math.random() * 1000 + 500;
                const startTime = Date.now();
                
                activeParticles.push({
                    element: particle,
                    x, y, vx, vy,
                    startTime,
                    lifespan
                });
                
                particles.appendChild(particle);
            }
        }
        
        // Update particles
        function updateParticles() {
            const currentTime = Date.now();
            for (let i = activeParticles.length - 1; i >= 0; i--) {
                const p = activeParticles[i];
                const age = currentTime - p.startTime;
                
                if (age >= p.lifespan) {
                    particles.removeChild(p.element);
                    activeParticles.splice(i, 1);
                    continue;
                }
                
                p.x += p.vx;
                p.y += p.vy;
                p.element.style.left = p.x + 'px';
                p.element.style.top = p.y + 'px';
                
                const opacity = 1 - (age / p.lifespan);
                p.element.style.opacity = opacity;
            }
        }
        
        // Check if a zone is safe (no overlaps)
        function isZoneSafe(lane, y, height) {
            const buffer = 100; // Minimum distance between objects
            
            // Check if this zone overlaps with any existing safe zones
            for (let zone of safeZones) {
                // Check if in same lane and if vertical distance is less than buffer
                if (zone.lane === lane && Math.abs(zone.y - y) < (zone.height / 2 + height / 2 + buffer)) {
                    return false;
                }
            }
            
            return true;
        }
        
        // Add a zone to the safe zones list
        function addSafeZone(lane, y, height, expiryTime) {
            const zone = { lane, y, height, expiryTime };
            safeZones.push(zone);
            return zone;
        }
        
        // Update and clean up safe zones
        function updateSafeZones() {
            const currentTime = Date.now();
            
            // Remove expired safe zones
            safeZones = safeZones.filter(zone => {
                return !zone.expiryTime || zone.expiryTime > currentTime;
            });
            
            // Update positions of moving zones (traffic cars and powerups)
            for (let zone of safeZones) {
                if (zone.element) {
                    zone.y = parseInt(zone.element.style.top) + (zone.height / 2);
                }
            }
            
            if (DEBUG_MODE) {
                debugInfo.textContent = `Safe Zones: ${safeZones.length}`;
            }
        }
        
        // Boost function
        function activateBoost() {
            const currentTime = Date.now();
            if (currentTime - lastBoostTime >= boostCooldown && !boostActive) {
                boostActive = true;
                gameSpeed = 10;
                lastBoostTime = currentTime;
                
                // Create boost particles
                const playerX = parseInt(playerCar.style.left) + 25;
                const playerY = parseInt(playerCar.style.bottom || '20') + 80;
                createParticles(playerX, playerY, 20, '#ff3e00');
                
                setTimeout(() => {
                    if (boostActive) {
                        boostActive = false;
                        gameSpeed = Math.min(baseSpeed + (level * 0.5), 5);
                    }
                }, 1000);
            }
        }
        
        // Update boost bar
        function updateBoostBar() {
            const currentTime = Date.now();
            const timeSinceBoost = currentTime - lastBoostTime;
            const cooldownProgress = Math.min(timeSinceBoost / boostCooldown, 1);
            boostBar.style.width = `${cooldownProgress * 100}%`;
        }
        
        // Update powerup display
        function updatePowerupDisplay() {
            powerupDisplay.innerHTML = '';
            const currentTime = Date.now();
            
            if (scoreMultiplier > 1 && scoreMultiplierEndTime > currentTime) {
                const multiplierEl = document.createElement('div');
                multiplierEl.className = 'active-powerup multiplier';
                multiplierEl.innerHTML = `2x SCORE <span class="timer">${Math.ceil((scoreMultiplierEndTime - currentTime) / 1000)}s</span>`;
                powerupDisplay.appendChild(multiplierEl);
            }
            
            if (isInvincible && invincibilityEndTime > currentTime) {
                const invincibleEl = document.createElement('div');
                invincibleEl.className = 'active-powerup invincible';
                invincibleEl.innerHTML = `INVINCIBLE <span class="timer">${Math.ceil((invincibilityEndTime - currentTime) / 1000)}s</span>`;
                powerupDisplay.appendChild(invincibleEl);
            }
        }
        
        // Power-up class
        class PowerUp {
            constructor(type) {
                this.type = type;
                this.element = document.createElement('div');
                this.element.className = `powerup ${type}`;
                
                // Add icon based on type
                const iconContent = this.type === 'speed-boost' ? '‚ö°' : this.type === 'invincibility' ? 'üõ°Ô∏è' : '√ó2';
                this.element.innerHTML = iconContent;
                
                // Find a safe lane
                let safeLaneFound = false;
                let attempts = 0;
                
                while (!safeLaneFound && attempts < 10) {
                    this.lane = Math.floor(Math.random() * laneCount);
                    this.y = -30;
                    
                    if (isZoneSafe(this.lane, this.y, 30)) {
                        safeLaneFound = true;
                    }
                    
                    attempts++;
                }
                
                if (!safeLaneFound) {
                    // If no safe lane found after 10 attempts, don't spawn
                    this.shouldRemove = true;
                    return;
                }
                
                this.x = lanes[this.lane] + 10;
                this.element.style.left = this.x + 'px';
                this.element.style.top = this.y + 'px';
                gameArea.appendChild(this.element);
                
                // Add to safe zones
                this.safeZone = addSafeZone(this.lane, this.y, 30);
                this.safeZone.element = this.element;
            }

            move() {
                if (this.shouldRemove) return false;
                
                this.y += gameSpeed;
                this.element.style.top = this.y + 'px';
                
                if (this.y > 600) {
                    this.remove();
                    return false;
                }
                return true;
            }

            remove() {
                if (this.element && this.element.parentNode) {
                    gameArea.removeChild(this.element);
                }
                
                // Remove from safe zones
                if (this.safeZone) {
                    const index = safeZones.indexOf(this.safeZone);
                    if (index !== -1) {
                        safeZones.splice(index, 1);
                    }
                }
            }

            applyEffect() {
                switch (this.type) {
                    case 'speed-boost':
                        activateBoost();
                        break;
                    case 'invincibility':
                        isInvincible = true;
                        invincibilityEndTime = Date.now() + 5000;
                        playerCar.style.filter = 'drop-shadow(0 0 10px rgba(0, 198, 255, 0.7))';
                        createParticles(parseInt(playerCar.style.left) + 25, 540, 15, '#00c6ff');
                        setTimeout(() => {
                            isInvincible = false;
                            playerCar.style.filter = boostActive ? 
                                'drop-shadow(0 0 5px rgba(255, 62, 0, 0.7))' : 
                                'drop-shadow(0 0 5px rgba(255, 62, 0, 0.7))';
                        }, 5000);
                        break;
                    case 'score-multiplier':
                        scoreMultiplier = 2;
                        scoreMultiplierEndTime = Date.now() + 10000;
                        createParticles(parseInt(playerCar.style.left) + 25, 540, 15, '#00e676');
                        setTimeout(() => scoreMultiplier = 1, 10000);
                        break;
                }
            }
        }

        // Traffic car class
        class TrafficCar {
            constructor() {
                this.element = document.createElement('div');
                this.element.className = 'traffic';
                
                // Randomize car color slightly
                const hue = 30 + Math.floor(Math.random() * 30);
                this.element.style.filter = `drop-shadow(0 0 5px rgba(255, ${hue}, 0, 0.7)) hue-rotate(${Math.random() * 30 - 15}deg)`;
                
                // Find a safe lane
                let safeLaneFound = false;
                let attempts = 0;
                
                while (!safeLaneFound && attempts < 10) {
                    this.lane = Math.floor(Math.random() * laneCount);
                    this.y = -80;
                    
                    if (isZoneSafe(this.lane, this.y, 80)) {
                        safeLaneFound = true;
                    }
                    
                    attempts++;
                }
                
                if (!safeLaneFound) {
                    // If no safe lane found after 10 attempts, don't spawn
                    this.shouldRemove = true;
                    return;
                }
                
                this.x = lanes[this.lane];
                this.element.style.left = this.x + 'px';
                this.element.style.top = this.y + 'px';
                gameArea.appendChild(this.element);
                
                // Add to safe zones
                this.safeZone = addSafeZone(this.lane, this.y, 80);
                this.safeZone.element = this.element;
            }

            move() {
                if (this.shouldRemove) return false;
                
                this.y += gameSpeed;
                this.element.style.top = this.y + 'px';
                
                if (this.y > 600) {
                    this.remove();
                    score += scoreMultiplier;
                    scoreDisplay.textContent = `Score: ${score}`;
                    
                    // Level up every 20 points
                    if (score > 0 && score % 20 === 0) {
                        levelUp();
                    }
                    
                    return false;
                }
                return true;
            }

            remove() {
                if (this.element && this.element.parentNode) {
                    gameArea.removeChild(this.element);
                }
                
                // Remove from safe zones
                if (this.safeZone) {
                    const index = safeZones.indexOf(this.safeZone);
                    if (index !== -1) {
                        safeZones.splice(index, 1);
                    }
                }
            }
        }

        // Level up function
        function levelUp() {
            level++;
            levelValue.textContent = level;
            baseSpeed += 0.5;
            
            // Create level up effect
            const levelUpText = document.createElement('div');
            levelUpText.textContent = `LEVEL ${level}!`;
            levelUpText.style.position = 'absolute';
            levelUpText.style.top = '50%';
            levelUpText.style.left = '50%';
            levelUpText.style.transform = 'translate(-50%, -50%)';
            levelUpText.style.color = '#00c6ff';
            levelUpText.style.fontFamily = 'Orbitron, sans-serif';
            levelUpText.style.fontSize = '48px';
            levelUpText.style.fontWeight = 'bold';
            levelUpText.style.textShadow = '0 0 10px rgba(0, 198, 255, 0.7)';
            levelUpText.style.zIndex = '100';
            levelUpText.style.opacity = '0';
            levelUpText.style.animation = 'fadeInOut 2s';
            
            gameArea.appendChild(levelUpText);
            
            setTimeout(() => {
                gameArea.removeChild(levelUpText);
            }, 2000);
            
            // Add CSS animation if it doesn't exist
            if (!document.querySelector('style').textContent.includes('fadeInOut')) {
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes fadeInOut {
                        0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
                        50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
                        100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // Collision detection with improved hitbox
        function checkCollision() {
            if (!isInvincible) {
                const playerRect = {
                    x: parseInt(playerCar.style.left) || lanes[playerLane],
                    y: 540, // Fixed player y position
                    width: 50,
                    height: 80
                };
                
                for (let car of trafficCars) {
                    if (car.shouldRemove) continue;
                    
                    const carRect = {
                        x: car.x,
                        y: car.y,
                        width: 50,
                        height: 80
                    };
                    
                    // More precise collision detection
                    const horizontalOverlap = Math.abs(playerRect.x - carRect.x) < (playerRect.width * 0.8);
                    const verticalOverlap = Math.abs(playerRect.y - carRect.y) < (playerRect.height * 0.7);
                    
                    if (horizontalOverlap && verticalOverlap) {
                        gameOver = true;
                        
                        // Create explosion effect
                        createParticles(parseInt(playerCar.style.left) + 25, 540, 30, '#ff1744');
                        
                        endGame(true);
                        return true;
                    }
                }
            }
            
            // Check for power-up collisions
            for (let i = powerups.length - 1; i >= 0; i--) {
                const pu = powerups[i];
                if (pu.shouldRemove) continue;
                
                const puRect = {
                    x: pu.x,
                    y: pu.y,
                    width: 30,
                    height: 30
                };
                
                const playerRect = {
                    x: parseInt(playerCar.style.left) || lanes[playerLane],
                    y: 540,
                    width: 50,
                    height: 80
                };
                
                // Check if power-up overlaps with player
                const horizontalOverlap = Math.abs(playerRect.x + playerRect.width/2 - (puRect.x + puRect.width/2)) < (playerRect.width/2 + puRect.width/2);
                const verticalOverlap = Math.abs(playerRect.y + playerRect.height/2 - (puRect.y + puRect.height/2)) < (playerRect.height/2 + puRect.height/2);
                
                if (horizontalOverlap && verticalOverlap) {
                    pu.applyEffect();
                    pu.remove();
                    powerups.splice(i, 1);
                }
            }
            return false;
        }

        // Calculate FPS
        function calculateFPS(timestamp) {
            if (!lastFrameTime) {
                lastFrameTime = timestamp;
                return 0;
            }
            
            const deltaTime = timestamp - lastFrameTime;
            lastFrameTime = timestamp;
            
            return Math.round(1000 / deltaTime);
        }

        // Game loop with timestamp for smoother animation
        function gameLoop(timestamp) {
            if (!gameRunning || gameOver) return;
            
            // Calculate FPS
            fps = calculateFPS(timestamp);
            
            if (DEBUG_MODE) {
                debugInfo.textContent = `FPS: ${fps} | Cars: ${trafficCars.length} | Powerups: ${powerups.length} | Zones: ${safeZones.length}`;
            }
            
            // Update safe zones
            updateSafeZones();
            
            // Spawn traffic cars based on level and with safe zone check
            if (Math.random() < 0.02 + (level * 0.003)) {
                const newCar = new TrafficCar();
                if (!newCar.shouldRemove) {
                    trafficCars.push(newCar);
                }
            }
            
            // Spawn power-ups with safe zone check
            if (Math.random() < 0.005) {
                const types = ['speed-boost', 'invincibility', 'score-multiplier'];
                const newPowerup = new PowerUp(types[Math.floor(Math.random() * 3)]);
                if (!newPowerup.shouldRemove) {
                    powerups.push(newPowerup);
                }
            }

            // Update game elements
            trafficCars = trafficCars.filter(car => car.move());
            powerups = powerups.filter(pu => pu.move());
            updateLaneMarkers();
            checkCollision();

            // Update game speed
            if (!boostActive) {
                gameSpeed = Math.min(baseSpeed + (level * 0.5), 5);
            }
            
            // Update speed display
            speedValue.textContent = (gameSpeed / baseSpeed).toFixed(1) + 'x';

            // Update UI elements
            updateBoostBar();
            updatePowerupDisplay();
            updateParticles();
            
            // Create road dust particles occasionally
            if (Math.random() < 0.1) {
                const x = parseInt(playerCar.style.left) + Math.random() * 50;
                const y = 540 + Math.random() * 60;
                createParticles(x, y, 1, 'rgba(255, 255, 255, 0.5)');
            }
            
            animationFrame = requestAnimationFrame(gameLoop);
        }

        // Start game
        function startGame() {
            if (gameRunning) return;
            gameRunning = true;
            gameOver = false;
            score = 0;
            level = 1;
            baseSpeed = 2;
            gameSpeed = baseSpeed;
            trafficCars = [];
            powerups = [];
            safeZones = [];
            scoreMultiplier = 1;
            isInvincible = false;
            lastBoostTime = 0;
            lastFrameTime = 0;
            scoreDisplay.textContent = `Score: ${score}`;
            levelValue.textContent = level;
            speedValue.textContent = '1.0x';
            playerLane = 2;
            updatePlayerPosition();
            startBtn.disabled = true;
            endBtn.disabled = false;
            
            // Clear any remaining particles
            particles.innerHTML = '';
            activeParticles = [];
            
            // Clear powerup display
            powerupDisplay.innerHTML = '';
            
            // Reset player car appearance
            playerCar.style.filter = 'drop-shadow(0 0 5px rgba(255, 62, 0, 0.7))';
            
            // Create lane markers if they don't exist
            if (laneMarkerPositions.length === 0) {
                createLaneMarkers();
            }
            
            gameLoop(0);
        }

        // Reset game state (for home)
        function resetGame() {
            gameRunning = false;
            gameOver = false;
            score = 0;
            level = 1;
            baseSpeed = 2;
            gameSpeed = baseSpeed;
            trafficCars.forEach(car => car.remove());
            powerups.forEach(pu => pu.remove());
            trafficCars = [];
            powerups = [];
            safeZones = [];
            scoreMultiplier = 1;
            isInvincible = false;
            lastBoostTime = 0;
            scoreDisplay.textContent = `Score: ${score}`;
            levelValue.textContent = level;
            speedValue.textContent = '1.0x';
            playerLane = 2;
            updatePlayerPosition();
            boostBar.style.width = '100%';
            startBtn.disabled = false;
            endBtn.disabled = true;
            
            // Clear any remaining particles
            particles.innerHTML = '';
            activeParticles = [];
            
            // Clear powerup display
            powerupDisplay.innerHTML = '';
            
            // Reset player car appearance
            playerCar.style.filter = 'drop-shadow(0 0 5px rgba(255, 62, 0, 0.7))';
            
            cancelAnimationFrame(animationFrame);
        }

        // End game
        function endGame(crashed = false) {
            gameRunning = false;
            gameOver = true;
            cancelAnimationFrame(animationFrame);
            startBtn.disabled = false;
            endBtn.disabled = true;
            
            // Remove all game elements
            trafficCars.forEach(car => car.remove());
            powerups.forEach(pu => pu.remove());
            trafficCars = [];
            powerups = [];
            safeZones = [];

            // Show game over modal
            finalScoreDisplay.textContent = score;
            finalLevelDisplay.textContent = level;
            gameOverModal.style.display = 'block';
            gameOverTitle.textContent = crashed ? 'CRASH!' : 'GAME OVER!';
        }

        // Button events
        startBtn.addEventListener('click', startGame);
        endBtn.addEventListener('click', () => endGame(false));

        // Initial position and boost bar
        updatePlayerPosition();
        updateBoostBar();
        
        // Add touch events for mobile
        let touchStartX = 0;
        gameArea.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
        });
        
        gameArea.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touchX = e.touches[0].clientX;
            const diff = touchX - touchStartX;
            
            if (diff > 50) {
                movePlayer('right');
                touchStartX = touchX;
            } else if (diff < -50) {
                movePlayer('left');
                touchStartX = touchX;
            }
        });
        
        // Double tap for boost
        let lastTap = 0;
        gameArea.addEventListener('touchend', () => {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            if (tapLength < 300 && tapLength > 0) {
                activateBoost();
            }
            lastTap = currentTime;
        });
        
        // Resize handler
        window.addEventListener('resize', () => {
            const newGameWidth = gameArea.offsetWidth;
            const newLaneWidth = newGameWidth / laneCount;
            
            for (let i = 0; i < laneCount; i++) {
                lanes[i] = (i * newLaneWidth) + (newLaneWidth - 50) / 2;
            }
            
            updatePlayerPosition();
            
            // Recreate lane markers on resize
            laneMarkerPositions = [];
            roadEdgeMarkerPositions = [];
            createLaneMarkers();
        });
    </script>
</body>
</html>